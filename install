#!/bin/bash

# install go, git, tmux, clang, libclang, ruby-dev
# vim should be built with python/ruby/lua support

set -e

vim_bundle_dir=~/.vim_bundle
vim_tmpdir=~/.vim_tmp

go_repos="github.com/jstemmer/gotags"

setup_vim()
{
	[ ! -d $vim_tmpdir ] && (rm -rf $vim_tmpdir && mkdir -p $vim_tmpdir)

	# neobundle
	rm -rf $vim_bundle_dir && mkdir -p $vim_bundle_dir
	git clone http://github.com/Shougo/neobundle.vim $vim_bundle_dir/neobundle
	vim  +qa
}

update_vim_plugins()
{
	vim +NeoBundleUpdate +qa
}

make_link()
{
	from=$1
	to=$2

	# backup if it exists and is not a symbolic link
	if [ -e $to -a ! -L $to ]; then
		rm -rfv $to.old && mv -f $to $to.old
	fi

	ln -sfTv $from $to # -T always treat $to as normal files
}

setup_link()
{
	make_link $PWD/dotbashrc               ~/.bashrc
	make_link $PWD/dotbash_aliases.sh      ~/.bash_aliases.sh
	make_link $PWD/dotgitconfig            ~/.gitconfig
	make_link $PWD/dotscreenrc             ~/.screenrc
	make_link $PWD/dottoprc                ~/.toprc
	make_link $PWD/dotgdbinit              ~/.gdbinit
	make_link $PWD/dotemacs                ~/.emacs
	make_link $PWD/dottmux.conf            ~/.tmux.conf
	make_link $PWD/dotprofile              ~/.bash_profile
	make_link $PWD/dotvimrc                ~/.vimrc
	make_link $PWD/dotvim                  ~/.vim
	make_link $PWD/dothgrc                 ~/.hgrc
}

update_files()
{
	./update-dircolor.sh
	./update-git-files.sh
	./update-tmux-files.sh
	./update-powerline-fonts.sh
}

update()
{
	setup_link
	echo "go get -u $go_repos"
	go get -u $go_repos
	update_files
	update_vim_plugins
}

install()
{
	[ -f ~/.profile ] && mv -v ~/.profile ~/.profile.bak
	setup_link
	. ~/.bash_profile
	echo "go get $go_repos"
	go get $go_repos
	update_files
	setup_vim
}

basename=`basename $0`

if [ $basename = "install" ]; then
	install
elif [ $basename = "update" ]; then
	update
fi

